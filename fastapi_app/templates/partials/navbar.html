<nav class="fixed w-full z-50 transition-all duration-300" id="navbar">
    {% include 'partials/lightbox_css.html' %}
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-20">
            <a href="/" class="flex items-center gap-2">
                <span class="font-bold text-2xl tracking-tight text-primary">ShaiX2</span>
            </a>
            <div class="hidden md:flex space-x-6 items-center">
                <a class="text-sm font-medium text-gray-600 dark:text-gray-300 hover:text-primary dark:hover:text-primary transition-colors"
                    href="/">Home</a>
                <a class="text-sm font-medium text-gray-600 dark:text-gray-300 hover:text-primary dark:hover:text-primary transition-colors"
                    href="/timeline">Timeline</a>
                <a class="text-sm font-medium text-gray-600 dark:text-gray-300 hover:text-primary dark:hover:text-primary transition-colors"
                    href="/gallery">Gallery</a>
                <a class="text-sm font-medium text-gray-600 dark:text-gray-300 hover:text-primary dark:hover:text-primary transition-colors"
                    href="/music">Music</a>
                <a class="text-sm font-medium text-gray-600 dark:text-gray-300 hover:text-primary dark:hover:text-primary transition-colors"
                    href="/coupons">Coupons</a>
                <a class="text-sm font-medium text-gray-600 dark:text-gray-300 hover:text-primary dark:hover:text-primary transition-colors"
                    href="/roka">Roka</a>
                <a class="text-sm font-medium text-gray-600 dark:text-gray-300 hover:text-primary dark:hover:text-primary transition-colors"
                    href="/wishlist">Wishlist</a>
                <a class="text-sm font-medium text-gray-600 dark:text-gray-300 hover:text-primary dark:hover:text-primary transition-colors"
                    href="/guestbook">Guestbook</a>
                <a class="text-sm font-medium text-gray-600 dark:text-gray-300 hover:text-primary dark:hover:text-primary transition-colors"
                    href="/upcoming">Upcoming</a>
                <a class="text-sm font-medium text-gray-600 dark:text-gray-300 hover:text-primary dark:hover:text-primary transition-colors"
                    href="/dictionary">Dictionary</a>
            </div>
            <!-- Play Theme Button (Global) -->
            <button id="play-theme-btn"
                class="hidden md:flex items-center space-x-2 bg-primary/10 hover:bg-primary/20 px-4 py-2 rounded-full transition-all group ml-4">
                <span class="material-icons text-primary text-sm group-hover:animate-pulse">music_note</span>
                <span class="text-xs font-semibold uppercase tracking-wider">Play Theme</span>
            </button>
            <!-- Mobile Menu Button (Hamburger) -->
            <div class="md:hidden flex items-center">
                <button
                    class="text-gray-600 dark:text-gray-300 hover:text-primary focus:outline-none mobile-menu-button">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>
    <!-- Mobile Menu -->
    <div
        class="md:hidden hidden mobile-menu bg-white dark:bg-background-dark border-t border-gray-100 dark:border-gray-800 absolute w-full left-0 top-20 shadow-lg">
        <a href="/" class="block py-4 px-6 text-sm hover:bg-gray-50 dark:hover:bg-white/5">Home</a>
        <a href="/timeline" class="block py-4 px-6 text-sm hover:bg-gray-50 dark:hover:bg-white/5">Timeline</a>
        <a href="/gallery" class="block py-4 px-6 text-sm hover:bg-gray-50 dark:hover:bg-white/5">Gallery</a>
        <div class="border-t border-gray-100 dark:border-gray-800 my-2"></div>
        <a href="/music" class="block py-3 px-6 text-sm hover:bg-gray-50 dark:hover:bg-white/5 flex items-center"><span
                class="material-icons text-sm mr-3 text-primary">music_note</span> Music</a>
        <a href="/coupons"
            class="block py-3 px-6 text-sm hover:bg-gray-50 dark:hover:bg-white/5 flex items-center"><span
                class="material-icons text-sm mr-3 text-primary">card_giftcard</span> Coupons</a>
        <a href="/roka" class="block py-3 px-6 text-sm hover:bg-gray-50 dark:hover:bg-white/5 flex items-center"><span
                class="material-icons text-sm mr-3 text-primary">favorite</span> Roka</a>
        <a href="/wishlist"
            class="block py-3 px-6 text-sm hover:bg-gray-50 dark:hover:bg-white/5 flex items-center"><span
                class="material-icons text-sm mr-3 text-primary">stars</span> Wishlist</a>
        <a href="/guestbook"
            class="block py-3 px-6 text-sm hover:bg-gray-50 dark:hover:bg-white/5 flex items-center"><span
                class="material-icons text-sm mr-3 text-primary">import_contacts</span> Guestbook</a>
        <a href="/upcoming"
            class="block py-3 px-6 text-sm hover:bg-gray-50 dark:hover:bg-white/5 flex items-center"><span
                class="material-icons text-sm mr-3 text-primary">event</span> Upcoming</a>
        <a href="/dictionary"
            class="block py-3 px-6 text-sm hover:bg-gray-50 dark:hover:bg-white/5 flex items-center"><span
                class="material-icons text-sm mr-3 text-primary">book</span> Dictionary</a>
    </div>
    <!-- Global Music Player (Hidden Logic) -->
    <audio id="global-theme-audio" loop>
        <source src="/static/theme_new.mp3" type="audio/mpeg">
    </audio>

    <script>
        // Mobile menu toggle logic
        const btn = document.querySelector("button.mobile-menu-button");
        const menu = document.querySelector(".mobile-menu");

        if (btn && menu) {
            btn.addEventListener("click", () => {
                menu.classList.toggle("hidden");
            });
        }

        // --- Global Music Player Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            const audio = document.getElementById('global-theme-audio');
            // Select both buttons if they exist
            const navbarBtn = document.getElementById('play-theme-btn');
            const heroBtn = document.getElementById('hero-play-btn');

            const buttons = [navbarBtn, heroBtn].filter(btn => btn !== null);

            // Function to update ALL buttons
            function updateButtonState(isPlaying) {
                buttons.forEach(btn => {
                    // Start by finding the text and icon elements regardless of specific structure
                    // Navbar button structure: icon first, then text span
                    // Hero button structure: text span first, then icon

                    const spans = btn.getElementsByTagName('span');
                    let textSpan, iconSpan;

                    // Simple heuristic: Material Icons usually have 'material-icons' class or content length is small/specific
                    for (let span of spans) {
                        if (span.classList.contains('material-icons') || span.classList.contains('material-icons-round')) {
                            iconSpan = span;
                        } else {
                            textSpan = span;
                        }
                    }

                    if (isPlaying) {
                        if (iconSpan) {
                            iconSpan.textContent = 'pause';
                            iconSpan.classList.remove('group-hover:animate-pulse', 'group-hover:animate-spin');
                        }
                        if (textSpan) {
                            // Keep original label context if possible, but standardizing for now
                            textSpan.textContent = btn.id === 'hero-play-btn' ? 'Pause Our Song' : 'Pause Theme';
                        }
                        btn.classList.add('bg-primary/20', 'ring-2', 'ring-primary'); // Visual active state
                    } else {
                        if (iconSpan) {
                            iconSpan.textContent = 'music_note';
                            // Restore animations based on button type
                            if (btn.id === 'hero-play-btn') iconSpan.classList.add('group-hover:animate-spin');
                            else iconSpan.classList.add('group-hover:animate-pulse');
                        }
                        if (textSpan) {
                            textSpan.textContent = btn.id === 'hero-play-btn' ? 'Play Our Song' : 'Play Theme';
                        }
                        btn.classList.remove('bg-primary/20', 'ring-2', 'ring-primary');
                    }
                });
            }

            // Check localStorage for saved state
            const savedTime = localStorage.getItem('themeAudioTime');
            const wasPlaying = localStorage.getItem('themeAudioPlaying') === 'true';

            if (savedTime) {
                audio.currentTime = parseFloat(savedTime);
            }

            // Auto-play if it was playing
            if (wasPlaying) {
                const playPromise = audio.play();
                if (playPromise !== undefined) {
                    playPromise.then(_ => updateButtonState(true))
                        .catch(error => {
                            console.log("Auto-play prevented");
                            updateButtonState(false);
                            localStorage.setItem('themeAudioPlaying', 'false');
                        });
                }
            } else {
                updateButtonState(false);
            }

            // Toggle Logic for ALL buttons
            buttons.forEach(btn => {
                btn.classList.remove('hidden');
                btn.addEventListener('click', (e) => {
                    // Prevent bubbling if needed, though usually fine
                    if (audio.paused) {
                        audio.play();
                        updateButtonState(true);
                        localStorage.setItem('themeAudioPlaying', 'true');
                    } else {
                        audio.pause();
                        updateButtonState(false);
                        localStorage.setItem('themeAudioPlaying', 'false');
                    }
                });
            });
            updateButtonState(false);
            localStorage.setItem('themeAudioPlaying', 'false');
            audio.addEventListener('timeupdate', () => {
                localStorage.setItem('themeAudioTime', audio.currentTime);
            });

            // Ensure state is saved on unload
            window.addEventListener('beforeunload', () => {
                localStorage.setItem('themeAudioTime', audio.currentTime);
                localStorage.setItem('themeAudioPlaying', !audio.paused);
            });

            // Cross-tab Synchronization
            window.addEventListener('storage', (event) => {
                if (event.key === 'themeAudioPlaying') {
                    const shouldPlay = event.newValue === 'true';
                    if (shouldPlay && audio.paused) {
                        audio.play()
                            .then(() => updateButtonState(true))
                            .catch(e => console.log("Cross-tab play block:", e));
                    } else if (!shouldPlay && !audio.paused) {
                        audio.pause();
                        updateButtonState(false);
                    }
                }
            });
        });
    </script>
</nav>